---
title: "Suomalaiset arvostavat nyt enemmän urbaaneja asuinympäristöjä kuin aiemmin"
output: html_document
---

TL;DR: Tiheästi asuttujen alueiden asuntojen hinnat ovat muutamana viime vuotena nousseet harvemmin asuttujen alueiden hintoja nopeammin koko Suomessa ja erityisesti pääkaupunkiseudulla. Tämä on todennäköisesti seurausta siitä, että ihmiset arvostavat nykyään enemmän urbaaneja asuinympäristöjä.   

Maailmalla on vallannut alaa uusi urbanismin aalto, jossa ihmiset haluavat muuttaa tiiviisiin kaupunkikeskustoihin omakotitalolähiöiden sijaan (ks esim. http://www.nytimes.com/2014/04/17/opinion/americas-urban-future.html). Korkeasta väestötiheydestä sanotaan olevan monia etuja: Se tarjoaa monipuoliset palvelut, työpaikkojen ja palveluiden hyvän saavutettavuuden, mahdollisuuden rakentaa viihtyisää kävely-ympäristöä ja tehokkaasti toimivan joukkoliikenteen. Lisäksi tiivis rakentaminen säästää viheralueita ja luo edellytykset talouskasvulle mm. sen tähden, että saman alan yritykset saavat lähekkäin sijaitsemisesta kasautumisetuja.

Millainen kehitys on Suomessa? Asuntojen hintojen muutokset kuvastavat muutoksia siinä, mitä asukkaan arvostavat, eli millaisssa asunnoissa he haluaisivat asua. [Reaktor Oy:n data scientistit](http://reaktor.fi/datascience), joihin itsekin kuulun, [mallinsivat](http://louhos.github.io/news/2015/05/07/asuntohintojen-muutokset/) asuntojen hintojen kehitystä vuosina 2005-2014 ja tekivät niistä [interaktiivisen kartan](http://kannattaakokauppa.fi). Malli antaa postinumerotasolla asuntojen hinnan kehityksen keskineliöhintana, lineaarisena trendinä ja trendin muutoksena. Näiden perusteella voidaan tutkia asukkaiden arvostusten muutoksia. 

Asuinalueen urbaaniudelle on monia mittareita, joista yksinkertaisin on väestötiheys. Allaolevasta kuvaajasta nähdään, että koko Suomessa ei juurikaan ole yhteyttä asuntojen hinnan ja asuinalueen väestötiheyden välillä. Vaaka-akseli kuvaa väestötiheyttä asukkaina neliökilometrillä logaritmisella skaalalla, pystyakseli ennustettua hinnan muutosta vuonna 2016 prosentteina per vuosi ja jokaiselle postinumeroalueelle on erillinen pisteensä. 

```{r, echo=FALSE, warning=FALSE, results='hide', message=FALSE}
# Script for analysing the relation between trends density and price trends
library("ggplot2")
library("sorvi")
#library("mgcv")
library("MASS")
library("dplyr")

# FIXME: path to be relative; now knit2html() behaves differently from source()
population <- read.csv("/Users/jaakkos/github.reaktor/Neliohinnat/data/pnro-hinnat.txt", sep=" ", header=T, colClasses="character",row.names=1)
population$logtiheys <- -10*as.numeric(population$log.density)
#population$hintataso <- as.numeric(population$hinta2016)
#population$trendi <- 100*as.numeric(population$trendi2016)
#population$trendimuutos <- 100*as.numeric(population$trendimuutos)

pc <- get_postal_code_info()
population <- left_join(mutate(population,pnro = rownames(population)),pc,by = c("pnro" = "postal.code"))

trends <- readRDS("/Users/jaakkos/Dropbox (reaktor.fi)/Predictive Analytics/Neliohinnat/yearly-trends.rds")

trends <- left_join(trends,population,by = "pnro")
trends <- rename(trends,kunta = municipality)

ymin = -0.016
ymax = 0.002
xmin = 0
xmax = 4.5

isot = c("Helsinki","Espoo","Tampere","Vantaa","Oulu","Turku","Jyväskylä","muu")
#isot = c("Pääkaupunkiseutu","Helsinki","Espoo","Tampere","Vantaa","Oulu","Turku","Jyväskylä","Kuopio","Lahti","Kouvola","muu")
pk = c("Helsinki")
pks = c("Helsinki","Espoo","Vantaa","Kauniainen")
pksiso = c("Helsinki","Espoo","Vantaa","Kauniainen","Kirkkonummi","Siuntio","Vihti","Nurmijärvi","Kerava","Sipoo","Pornainen","Mäntsälä","Tuusula","Järvenpää")

trends[!trends$kunta %in% isot,]$kunta = 'muu'

library(scales)
#log.vals = seq(-2, 4, 2)
log.vals = c(-1,0,2,4)

norm.vals <- 10**(log.vals)

# koko Suomen ajallinen trendi vs tiheys
gg <- ggplot(transform(filter(trends,year<2015), year=factor(year)), aes(logtiheys,trend.y.mean),) + geom_point(size=1,aes(color=trend.y.mean>0)) + geom_smooth(method="rlm") + 
  facet_wrap(~year, ncol=3) + xlab('Tiheys (as / km^2)') + ylab("Trendi (% / vuosi)") + scale_x_continuous(breaks = log(norm.vals), labels=norm.vals)
print(gg)

# Helsingin ajallinen trendi vs tiheys
selkunta = "Helsinki"
gg <- ggplot(transform(filter(trends,kunta==selkunta,year<2015), year=factor(year)), aes(logtiheys,trend.y.mean),) + geom_point(size=1,aes(color=trend.y.mean>0)) + geom_smooth(method="rlm") + 
  facet_wrap(~year, ncol=3) + xlab('Tiheys (as / km^2)') + ylab("Trendi (% / vuosi)") + scale_x_continuous(breaks = log(norm.vals), labels=norm.vals) 
print(gg)

```

Kuvaajasta nähdään selvästi, että tiheästi asuttujen alueiden hinnat laskevat hitaammin kuin muun Suomen hinnat tai jopa nousevat vielä.

Tilannetta voidaan tarkastella myös yksittäisten kuntien osalta. Alle on kuvattu yhteys väestötiheyden ja lineaarisen hintakehityksen välillä Suomen kymmenen suurimman kaupungin osalta. 

```{r, echo=FALSE, warning=FALSE}


# isojen kaupunkien trendi vs tiheys

#fit <- group_by(filter(trends,year<2015),kunta,year) %>% do(mod = rlm(trend.y.mean ~ logtiheys,data = .))

fit <- group_by(filter(trends,year<2015),kunta,year) %>% do({ mod <- rlm(trend.y.mean ~ logtiheys,data = .); data.frame(k=coef(mod)[["logtiheys"]])}) 

# for (selkunta in isot){
#   for (selyear in years){
#     linear = rlm(trend.y.mean ~ logtiheys,filter(trends,year==selyear,kunta==selkunta))
#     coeff = c(coeff,linear$coefficients[2])
#     year = c(year,selyear)
#     kunta = c(kunta,selkunta)
#   }
# }

# lintrends = data.frame(kunta,year,coeff)
gg <- ggplot(fit, aes(year,k)) + geom_point(size=1,) +#aes(color=k>0)) + 
  geom_smooth(method="rlm") + facet_wrap(~kunta, ncol=3) + xlab('Vuosi') + ylab("Lin. kerroin") 
print(gg)

# gg <- ggplot(transform(lintrends, kunta=factor(kunta, levels=isot)), aes(year,coeff)) + geom_point(size=1,aes(color=coeff>0)) + 
#   geom_smooth(method="rlm") + facet_wrap(~kunta, ncol=3) + xlab('Vuosi') + ylab("Lin. kerroin") 
# print(gg)

```

Kuvaajista huomataan, että 

Seuraavaksi tutkitaan hintojen muutosten ja väestötiheyden korrelaatiota vuosi vuodelta. 
1) kaikille isoille kaupungeille ja 'muu'lle lasketaan kunkin vuoden trendille lineaarinen malli väestötiheyden suhteen
2) plotataan kaikki vuodet
```{r, echo=FALSE, warning=FALSE}


```

